<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>일기장 멤버 관리</title>
    <link rel="stylesheet" th:href="@{/css/common.css}" />
    <link rel="stylesheet" th:href="@{/css/manage_member.css}" />
  </head>
  <body>
    <div th:replace="~{fragments/header :: header}"></div>
    <h2>👥 멤버 관리</h2>

    <table>
      <thead>
        <tr>
          <th>닉네임</th>
          <th>역할</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="member : ${members}">
          <td th:text="${member.nickname}">닉네임</td>
          <td>
            <span th:if="${member.role.name() == 'OWNER'}">👑 Owner</span>
            <span th:if="${member.role.name() == 'GUEST'}">👤 Guest</span>
          </td>
          <td>
            <button
              class="btn btn-danger"
              th:if="${member.role.name() == 'GUEST'}"
              th:onclick="|kickMember(${diaryId}, ${member.id})|"
            >
              🚫 추방
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="invite-form">
      <h3>📨 새 멤버 초대</h3>
      <input type="email" id="invite-email" placeholder="이메일 입력" />
      <button onclick="sendInvite()">초대</button>
    </div>

    <script>
        const diaryId = [[${diaryId}]];

        function kickMember(diaryId, memberId) {
          if (!confirm("정말 추방하시겠습니까?")) return;
          fetch(`/api/diary/${diaryId}/members/${memberId}`, { method: "DELETE" })
            .then((res) => {
              if (!res.ok) throw new Error("추방 실패");
              alert("추방 완료");
              location.reload();
            })
            .catch((err) => alert(err.message));
        }

        function sendInvite() {
          const email = document.getElementById("invite-email").value.trim();

          if (!email) {
            alert("이메일을 입력해주세요.");
            return;
          }

          fetch(`/api/diary/${diaryId}/invite`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          })
            .then(async (res) => {
      if (!res.ok) {
        let errorMessage = "초대 실패";
        try {
          const errorData = await res.json();
          if (errorData.message) errorMessage = errorData.message;
        } catch (err) {
          console.warn("JSON 파싱 실패:", err);
        }
        throw new Error(errorMessage);
      }
              alert("초대가 성공적으로 전송되었습니다.");
              document.getElementById("invite-email").value = "";
            })
            .catch((err) => {
              alert("❗Error : " + err.message);
            });
        }
    </script>
  </body>
</html>
